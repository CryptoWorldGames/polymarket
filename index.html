<script>
  const PROXY = "https://api.allorigins.win/raw?url=";
  const API_BASE = "https://gamma-api.polymarket.com";
  let currentSlug = "";

  function extractSlug(input) {
    input = input.trim();
    input = input.split("?")[0].split("#")[0].replace(/\/$/, '');
    if (input.includes("/event/")) {
      return input.split("/event/")[1];
    }
    return input;
  }

  async function fetchWithProxy(url) {
    try {
      const response = await fetch(PROXY + encodeURIComponent(url));
      if (!response.ok) return null;
      return await response.json();
    } catch {
      return null;
    }
  }

  async function fetchMarket(slug) {
    const url = `${API_BASE}/markets?slug=${encodeURIComponent(slug)}`;
    return await fetchWithProxy(url).then(data => data ? data[0] : null);
  }

  async function fetchAllMarkets() {
    const url = `${API_BASE}/markets?limit=500&active=true&closed=false`;
    return await fetchWithProxy(url) || [];
  }

  function getRecommendation(yesPrice) {
    if (yesPrice >= 0.70) return { text: "BUY UP", class: "buy-up" };
    if (yesPrice <= 0.30) return { text: "BUY DOWN", class: "buy-down" };
    if (yesPrice >= 0.45 && yesPrice <= 0.55) return { text: "DON'T BUY", class: "no-buy" };
    return { text: "NO EDGE", class: "no-edge" };
  }

  async function analyzeMarket() {
    const input = document.getElementById("marketInput").value.trim();
    if (!input) {
      document.getElementById("status").textContent = "Please paste the full URL";
      return;
    }

    currentSlug = extractSlug(input);
    document.getElementById("status").textContent = `Analyzing: ${currentSlug}...`;
    document.getElementById("result").textContent = "Loading...";
    document.getElementById("result").className = "no-buy";

    const market = await fetchMarket(currentSlug);
    if (!market) {
      document.getElementById("status").textContent = "Market not found";
      document.getElementById("result").textContent = "Invalid market";
      document.getElementById("result").className = "no-buy";
      return;
    }

    const outcomes = market.outcomePrices || [];
    if (outcomes.length !== 2) {
      document.getElementById("status").textContent = "Not a binary market";
      document.getElementById("result").textContent = "Invalid market";
      document.getElementById("result").className = "no-buy";
      return;
    }

    const yesPrice = parseFloat(outcomes[0] || 0); // Up/Yes is first
    const rec = getRecommendation(yesPrice);

    document.getElementById("result").textContent = rec.text;
    document.getElementById("result").className = rec.class;
    document.getElementById("status").textContent = 
      `Market: ${market.question || market.title} | Yes (Up): ${(yesPrice * 100).toFixed(1)}% | Updated: ${new Date().toLocaleTimeString()}`;
  }

  async function scanForArb() {
    const markets = await fetchAllMarkets();
    const tableBody = document.getElementById("arbTable");
    tableBody.innerHTML = "";

    let found = false;
    markets.forEach(m => {
      const outcomes = m.outcomePrices || [];
      if (outcomes.length !== 2) return;

      const yesP = parseFloat(outcomes[0] || 0);
      const noP = parseFloat(outcomes[1] || 0);
      const total = yesP + noP;

      if (total < 0.99) {
        found = true;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${m.question || m.title}</td>
          <td>${(yesP * 100).toFixed(1)}%</td>
          <td>${(noP * 100).toFixed(1)}%</td>
          <td class="arb">${(total * 100).toFixed(1)}%</td>
          <td><a href="https://polymarket.com/event/${m.slug}" target="_blank" class="link">Open</a></td>
        `;
        tableBody.appendChild(row);
      }
    });

    document.getElementById("arb-status").textContent = found 
      ? "⚠️ Mismatch(s) found! (check red percentages)"
      : `No mismatches found. Last scan: ${new Date().toLocaleTimeString()}`;
  }

  setInterval(() => { if (currentSlug) analyzeMarket(); }, 15000);
  setInterval(scanForArb, 15000);
  scanForArb();

  document.getElementById("marketInput").addEventListener("keypress", e => {
    if (e.key === "Enter") analyzeMarket();
  });
</script>