<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Polymarket GPT Bot Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!--
File: gptbot.html
Version: v0003
Purpose:
- Browser-only Polymarket scanner
- Category filters via checkboxes
- Hard AI rate limit (1 call / 5s)
- Safer notifications + API protection
-->

<style>
body {
  font-family: Arial, sans-serif;
  background: #0d1117;
  color: #e6edf3;
  margin: 20px;
  text-align: center;
}
h1 { color: #58a6ff; }
input, select, button, label {
  font-size: 14px;
}
input, select {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #30363d;
  background: #161b22;
  color: #e6edf3;
}
button {
  padding: 10px 18px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  margin: 5px;
}
.start { background: #238636; color: #fff; }
.stop { background: #da3633; color: #fff; }
.panel {
  max-width: 900px;
  margin: 20px auto;
  background: #161b22;
  padding: 15px;
  border-radius: 12px;
  text-align: left;
}
.filters label {
  margin-right: 12px;
}
table {
  width: 95%;
  margin: 20px auto;
  border-collapse: collapse;
  background: #161b22;
}
th, td {
  padding: 10px;
  border-bottom: 1px solid #30363d;
  text-align: left;
}
th { background: #1f6feb; }
a { color: #58a6ff; text-decoration: none; }
footer {
  margin-top: 50px;
  font-size: 12px;
  color: #6e7681;
}
</style>
</head>

<body>

<h1>Polymarket GPT Bot Scanner</h1>
<p>Scans once per minute. AI research limited to 1 call every 5 seconds.</p>

<input
  type="password"
  id="apiKey"
  placeholder="Paste OpenAI API key"
  style="width: 260px;"
/>

<br/><br/>

<label>
  Probability Threshold:
  <select id="threshold">
    <option value="0.90">90%+</option>
    <option value="0.95" selected>95%+</option>
    <option value="0.98">98%+</option>
  </select>
</label>

<div class="panel filters">
  <strong>Market Filters:</strong><br/><br/>
  <label><input type="checkbox" data-cat="politics" checked> Politics</label>
  <label><input type="checkbox" data-cat="crypto" checked> Crypto / Markets</label>
  <label><input type="checkbox" data-cat="tech" checked> Tech / AI</label>
  <label><input type="checkbox" data-cat="culture" checked> Culture / Celebs</label>
  <label><input type="checkbox" data-cat="geo" checked> Geopolitics / War</label>
  <label><input type="checkbox" data-cat="sports"> Sports</label>
  <label><input type="checkbox" data-cat="other" checked> Other</label>
</div>

<button class="start" id="start">START SCANNER</button>
<button class="stop" id="stop" disabled>STOP SCANNER</button>

<div class="panel">
  <div>Status: <span id="status">Stopped</span></div>
  <div>Last Scan: <span id="lastScan">â€”</span></div>
  <div>Markets Scanned: <span id="scanned">0</span></div>
  <div>Markets Matched: <span id="matched">0</span></div>
  <div>AI Calls Used: <span id="aiCalls">0</span></div>
  <div>AI Cooldown: <span id="cooldown">Ready</span></div>
</div>

<table>
<thead>
<tr>
<th>Market</th>
<th>Side</th>
<th>Prob</th>
<th>AI Verdict</th>
<th>Link</th>
</tr>
</thead>
<tbody id="results"></tbody>
</table>

<footer>gptbot.html v0003</footer>

<script>
const API = "https://gamma-api.polymarket.com/markets?limit=500&active=true&closed=false";
const PROXY = "https://api.allorigins.win/raw?url=";
const SCAN_INTERVAL = 60000;
const AI_COOLDOWN_MS = 5000;

let timer = null;
let aiQueue = [];
let aiBusy = false;
let lastAiTime = 0;
let seen = new Set();
let aiCount = 0;

function now() { return Date.now(); }

async function fetchJSON(url) {
  try {
    const r = await fetch(PROXY + encodeURIComponent(url));
    if (!r.ok) return null;
    return await r.json();
  } catch {
    return null;
  }
}

function categoryOf(title) {
  const t = title.toLowerCase();
  if (t.match(/win|championship|super bowl|match|season/)) return "sports";
  if (t.match(/bitcoin|eth|gold|stock|market|inflation/)) return "crypto";
  if (t.match(/ai|openai|google|meta|tech/)) return "tech";
  if (t.match(/war|nato|china|russia|iran|ukraine/)) return "geo";
  if (t.match(/divorce|album|movie|celebrity/)) return "culture";
  if (t.match(/election|president|trump|congress/)) return "politics";
  return "other";
}

async function aiWorker() {
  if (aiBusy || aiQueue.length === 0) return;
  const wait = Math.max(0, AI_COOLDOWN_MS - (now() - lastAiTime));
  if (wait > 0) {
    document.getElementById("cooldown").textContent = `Waiting ${Math.ceil(wait/1000)}s`;
    setTimeout(aiWorker, wait);
    return;
  }

  aiBusy = true;
  document.getElementById("cooldown").textContent = "Running";
  const job = aiQueue.shift();
  lastAiTime = now();
  aiCount++;
  document.getElementById("aiCalls").textContent = aiCount;

  try {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${job.key}`
      },
      body: JSON.stringify({
        model: "gpt-4",
        messages: [{
          role: "user",
          content: `Assess if this outcome is genuinely near-certain. Mention any hidden risks:\n"${job.title}"`
        }]
      })
    });
    const data = await res.json();
    job.cell.textContent =
      data.choices?.[0]?.message?.content || "No response";
  } catch {
    job.cell.textContent = "AI failed";
  }

  aiBusy = false;
  document.getElementById("cooldown").textContent = "Ready";
  setTimeout(aiWorker, 100);
}

async function scan() {
  document.getElementById("lastScan").textContent = new Date().toLocaleTimeString();
  const markets = await fetchJSON(API) || [];
  document.getElementById("scanned").textContent = markets.length;

  const threshold = parseFloat(document.getElementById("threshold").value);
  const enabledCats = [...document.querySelectorAll(".filters input:checked")]
    .map(c => c.dataset.cat);

  let matched = 0;

  for (const m of markets) {
    let prices = m.outcomePrices;
    if (typeof prices === "string") {
      try { prices = JSON.parse(prices); } catch { continue; }
    }
    if (!Array.isArray(prices) || prices.length !== 2) continue;

    const yes = prices[0], no = prices[1];
    let side = null, prob = 0;
    if (yes >= threshold) { side = "YES"; prob = yes; }
    else if (no >= threshold) { side = "NO"; prob = no; }
    else continue;

    const cat = categoryOf(m.question || "");
    if (!enabledCats.includes(cat)) continue;

    matched++;
    if (seen.has(m.slug)) continue;
    seen.add(m.slug);

    const row = document.createElement("tr");
    const verdictCell = document.createElement("td");
    verdictCell.textContent = "Queued";

    row.innerHTML = `
      <td>${m.question}</td>
      <td>${side}</td>
      <td>${(prob*100).toFixed(1)}%</td>
    `;
    row.appendChild(verdictCell);
    row.innerHTML += `<td><a href="https://polymarket.com/event/${m.slug}" target="_blank">Open</a></td>`;
    document.getElementById("results").prepend(row);

    aiQueue.push({
      title: m.question,
      cell: verdictCell,
      key: document.getElementById("apiKey").value.trim()
    });
  }

  document.getElementById("matched").textContent = matched;
  aiWorker();
}

document.getElementById("start").onclick = () => {
  if (!document.getElementById("apiKey").value.trim()) {
    alert("Paste API key first");
    return;
  }
  if (timer) return;
  document.getElementById("status").textContent = "Running";
  scan();
  timer = setInterval(scan, SCAN_INTERVAL);
  document.getElementById("start").disabled = true;
  document.getElementById("stop").disabled = false;
};

document.getElementById("stop").onclick = () => {
  clearInterval(timer);
  timer = null;
  aiQueue = [];
  aiBusy = false;
  document.getElementById("status").textContent = "Stopped";
  document.getElementById("start").disabled = false;
  document.getElementById("stop").disabled = true;
};
</script>

</body>
</html>
