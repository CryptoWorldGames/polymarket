<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Polymarket GPT Bot Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!--
File: gptbot.html
Version: v0006

Short commit message:
Serialized AI queue with terminal states

Long commit message:
Fixes infinite “Researching…” states and OpenAI 429 errors
by enforcing a single global AI job queue with strict
serialization.

Introduces terminal AI states (SAFE, RISK, ERROR),
prevents duplicate re-queuing, adds tiered recheck
intervals (SAFE=60s, RISK=180s), preserves sticky
verdicts across scans, and tightens crypto-only filtering
to exclude macro and equity markets.
-->

<style>
body {
  background:#0d1117;
  color:#e6edf3;
  font-family:Arial,sans-serif;
  text-align:center;
  margin:20px;
}
h1 { color:#58a6ff; }
input, select {
  background:#161b22;
  color:#e6edf3;
  border:1px solid #30363d;
  border-radius:6px;
  padding:8px;
}
button {
  padding:10px 22px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  font-weight:bold;
}
button.start { background:#238636; color:white; }
button.stop { background:#da3633; color:white; }
.panel {
  max-width:900px;
  margin:20px auto;
  background:#161b22;
  padding:15px;
  border-radius:12px;
  text-align:left;
}
table {
  width:95%;
  margin:20px auto;
  border-collapse:collapse;
}
th,td {
  padding:10px;
  border-bottom:1px solid #30363d;
  text-align:left;
}
th { background:#1f6feb; }
.safe { color:#3fb950; font-weight:bold; }
.risk { color:#f85149; font-weight:bold; }
.error { color:#d29922; font-weight:bold; }
footer {
  margin-top:50px;
  font-size:12px;
  color:#6e7681;
}
</style>
</head>

<body>

<h1>Polymarket GPT Bot Scanner</h1>
<p>Research-first scanner. AI must justify safety.</p>

<input id="apiKey" type="password" placeholder="Paste OpenAI API key" style="width:260px">

<br><br>

<label>
Probability Threshold:
<select id="threshold">
  <option value="0.90">90%+</option>
  <option value="0.95" selected>95%+</option>
  <option value="0.98">98%+</option>
</select>
</label>

<div class="panel">
<strong>Market Filters</strong><br><br>
<label><input type="checkbox" data-cat="crypto" checked> Crypto</label>
<label><input type="checkbox" data-cat="politics"> Politics</label>
<label><input type="checkbox" data-cat="tech"> Tech / AI</label>
<label><input type="checkbox" data-cat="geo"> Geopolitics</label>
<label><input type="checkbox" data-cat="culture"> Culture</label>
<label><input type="checkbox" data-cat="sports"> Sports</label>
<label><input type="checkbox" data-cat="other"> Other</label>
</div>

<button id="toggleBtn" class="start">START SCANNER</button>

<div class="panel">
<div>Status: <span id="status">Stopped</span></div>
<div>AI Calls Used: <span id="aiCalls">0</span></div>
<div>AI Queue Length: <span id="queueLen">0</span></div>
</div>

<table>
<thead>
<tr>
<th>Market</th>
<th>Side</th>
<th>Prob</th>
<th>Status</th>
<th>Why (AI)</th>
<th>Link</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<footer>gptbot.html v0006</footer>

<script>
const API = "https://gamma-api.polymarket.com/markets?limit=500&active=true&closed=false";
const PROXY = "https://api.allorigins.win/raw?url=";

const MAX_ROWS = 20;
const SAFE_RECHECK = 60000;
const RISK_RECHECK = 180000;
const AI_COOLDOWN = 5000;

let running=false;
let aiQueue=[];
let aiBusy=false;
let aiCalls=0;
let markets=new Map();

async function fetchJSON(url){
  try{
    const r=await fetch(PROXY+encodeURIComponent(url));
    if(!r.ok) return null;
    return await r.json();
  }catch{ return null; }
}

function isCrypto(q){
  q=q.toLowerCase();
  return /(bitcoin|btc|ethereum|eth|solana|sol|usdt|usdc|stablecoin)/.test(q)
         && !/(market cap|largest company|apple|nvidia|amazon|google|microsoft)/.test(q);
}

function enqueueAI(m){
  if(m.state) return;
  m.state="QUEUED";
  aiQueue.push(m);
  document.getElementById("queueLen").textContent=aiQueue.length;
  processQueue();
}

async function processQueue(){
  if(aiBusy||!running||aiQueue.length===0) return;
  aiBusy=true;
  const m=aiQueue.shift();
  document.getElementById("queueLen").textContent=aiQueue.length;
  await aiCheck(m);
  setTimeout(()=>{ aiBusy=false; processQueue(); },AI_COOLDOWN);
}

async function aiCheck(m){
  aiCalls++;
  document.getElementById("aiCalls").textContent=aiCalls;
  try{
    const res=await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${document.getElementById("apiKey").value}`
      },
      body:JSON.stringify({
        model:"gpt-4",
        messages:[{
          role:"user",
          content:`Assess if this Polymarket outcome is extremely unlikely to reverse.
Consider liquidity, sibling ranges, late settlement risk.
Respond with SAFE or RISK, then one short reason (<=250 chars).

"${m.question}"`
        }]
      })
    });
    if(res.status===429) throw "RATE";
    const data=await res.json();
    const text=data.choices?.[0]?.message?.content||"RISK";
    if(text.startsWith("SAFE")){
      m.state="SAFE";
      m.why=text.slice(4).trim();
      m.nextCheck=Date.now()+SAFE_RECHECK;
    }else{
      m.state="RISK";
      m.why=text.replace("RISK","").trim();
      m.nextCheck=Date.now()+RISK_RECHECK;
    }
  }catch(e){
    m.state="ERROR";
    m.why="Rate limited or API error. Retry in 3 minutes.";
    m.nextCheck=Date.now()+RISK_RECHECK;
  }
  render();
}

function render(){
  const body=document.getElementById("rows");
  body.innerHTML="";
  [...markets.values()].forEach(m=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${m.question}</td>
      <td>${m.side}</td>
      <td>${(m.prob*100).toFixed(1)}%</td>
      <td class="${m.state==="SAFE"?"safe":m.state==="RISK"?"risk":"error"}">
        ${m.state}
      </td>
      <td>${m.why||""}</td>
      <td><a href="https://polymarket.com/event/${m.slug}" target="_blank">Open</a></td>
    `;
    body.appendChild(tr);
  });
}

async function scan(){
  const data=await fetchJSON(API)||[];
  const threshold=parseFloat(document.getElementById("threshold").value);
  markets.clear();
  for(const m of data){
    if(markets.size>=MAX_ROWS) break;
    if(!isCrypto(m.question)) continue;
    let p=m.outcomePrices;
    if(typeof p==="string"){ try{p=JSON.parse(p);}catch{continue;} }
    if(!Array.isArray(p)||p.length!==2) continue;
    let side=null,prob=0;
    if(p[0]>=threshold){side="YES";prob=p[0];}
    else if(p[1]>=threshold){side="NO";prob=p[1];}
    else continue;
    markets.set(m.slug,{...m,side,prob,state:null,why:""});
  }
  render();
  markets.forEach(enqueueAI);
}

document.getElementById("toggleBtn").onclick=()=>{
  if(!running){
    if(!document.getElementById("apiKey").value.trim()){
      alert("Paste API key first");
      return;
    }
    running=true;
    document.getElementById("status").textContent="Running";
    document.getElementById("toggleBtn").textContent="STOP SCANNER";
    document.getElementById("toggleBtn").className="stop";
    scan();
  }else{
    running=false;
    aiQueue=[];
    aiBusy=false;
    document.getElementById("status").textContent="Stopped";
    document.getElementById("toggleBtn").textContent="START SCANNER";
    document.getElementById("toggleBtn").className="start";
  }
};
</script>

</body>
</html>
