<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Polymarket GPT Bot Scanner v9</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Crypto YES/NO market scanner for Polymarket">

<style>
body {
  margin: 0;
  background: #0b0f14;
  color: #e6edf3;
  font-family: Arial, sans-serif;
}

.version {
  position: fixed;
  top: 6px;
  left: 14px;
  font-size: 12px;
  opacity: 0.6;
}

header {
  text-align: center;
  padding: 18px;
  border-bottom: 1px solid #1f2933;
}

h1 {
  margin: 0;
  color: #4da3ff;
}

.controls {
  padding: 14px 16px;
  border-bottom: 1px solid #1f2933;
}

input[type=password] {
  padding: 6px;
  width: 300px;
}

button {
  padding: 8px 16px;
  font-weight: bold;
  border: none;
  cursor: pointer;
}

.start { background: #16a34a; color: #fff; }
.stop  { background: #dc2626; color: #fff; }

.status {
  margin-top: 8px;
  font-size: 14px;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 8px;
  border-bottom: 1px solid #1f2933;
}

th { color: #93c5fd; }

a.market {
  color: #2dd4bf;
  text-decoration: underline;
}

.risk-safe { color: #22c55e; }
.risk-mid  { color: #eab308; }
.risk-high { color: #ef4444; }
</style>
</head>

<body>

<div class="version">v9 Â· build 9.4</div>

<header>
  <h1>Polymarket GPT Bot Scanner v9</h1>
  <div>Research-first scanner. AI must justify safety.</div>
</header>

<div class="controls">
  <input id="apiKey" type="password"
    placeholder="Paste OpenAI API key (hidden)" />

  <button id="startBtn" class="start">START SCANNER</button>
  <button id="stopBtn" class="stop" style="display:none;">STOP SCANNER</button>

  <div class="status" id="status">Status: idle</div>
</div>

<table>
<thead>
<tr>
  <th>Market</th>
  <th>Side</th>
  <th>Prob</th>
  <th>Risk</th>
  <th>Time Left</th>
  <th>Status</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<script>
const WORKER =
  "https://solitary-paper-639a.cryptoworldgames.workers.dev";

let running = false;

document.getElementById("startBtn").onclick = startScan;
document.getElementById("stopBtn").onclick = stopScan;

function stopScan() {
  running = false;
  document.getElementById("status").textContent = "Status: stopped";
  document.getElementById("startBtn").style.display = "inline-block";
  document.getElementById("stopBtn").style.display = "none";
}

function timeLeft(end) {
  if (!end) return "unknown";
  const ms = new Date(end) - new Date();
  if (ms <= 0) return "ended";
  const m = Math.floor(ms / 60000);
  if (m < 60) return `${m}m`;
  const h = Math.floor(m / 60);
  if (h < 48) return `${h}h`;
  return `${Math.floor(h / 24)}d`;
}

async function startScan() {
  running = true;
  document.getElementById("rows").innerHTML = "";
  document.getElementById("status").textContent = "Status: scanning...";
  document.getElementById("startBtn").style.display = "none";
  document.getElementById("stopBtn").style.display = "inline-block";

  let markets;
  try {
    const res = await fetch(
      `${WORKER}/?url=https://gamma-api.polymarket.com/markets`
    );
    markets = await res.json();
  } catch {
    document.getElementById("status").textContent =
      "Status: failed to fetch markets";
    stopScan();
    return;
  }

  let shown = 0;

  for (const m of markets) {
    if (!running || shown >= 50) break;
    if (!m.active || m.closed) continue;

    // crypto only
    if (!m.category || !m.category.toLowerCase().includes("crypto")) continue;

    // YES / NO only
    if (!Array.isArray(m.outcomes) || m.outcomes.length !== 2) continue;

    // try to infer YES probability safely
    let priceYes =
      m.outcomePrices?.[0] ??
      m.outcomes?.[0]?.price ??
      m.outcomes?.[0]?.probability;

    if (typeof priceYes !== "number") continue;

    const prob = Math.round((1 - priceYes) * 100);
    if (prob <= 0 || prob >= 100) continue;

    const risk =
      prob >= 85 ? "SAFE" :
      prob >= 65 ? "MID" : "RISK";

    const riskClass =
      risk === "SAFE" ? "risk-safe" :
      risk === "MID"  ? "risk-mid"  : "risk-high";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <a class="market" target="_blank"
        href="https://polymarket.com/search?_q=${encodeURIComponent(m.question)}">
        ${m.question}
        </a>
      </td>
      <td>YES</td>
      <td>${prob}%</td>
      <td class="${riskClass}">${risk}</td>
      <td>${timeLeft(m.endDate)}</td>
      <td>LIVE</td>
    `;

    document.getElementById("rows").appendChild(tr);
    shown++;
  }

  document.getElementById("status").textContent =
    `Status: loaded ${shown} crypto markets`;

  stopScan();
}
</script>

</body>
</html>
