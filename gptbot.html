<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Polymarket GPT Bot Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!--
File: gptbot.html
Version: v0007
-->

<style>
body {
  background:#0d1117;
  color:#e6edf3;
  font-family:Arial,sans-serif;
  margin:20px;
}
h1 { color:#58a6ff; text-align:center; }

input, select {
  background:#161b22;
  color:#e6edf3;
  border:1px solid #30363d;
  border-radius:6px;
  padding:8px;
}

button {
  padding:10px 24px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  font-weight:bold;
}

button.start { background:#238636; color:white; }
button.stop { background:#da3633; color:white; }

.panel {
  max-width:1100px;
  margin:20px auto;
  background:#161b22;
  padding:15px;
  border-radius:12px;
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}

th, td {
  padding:10px;
  border-bottom:1px solid #30363d;
  font-size:14px;
}

th { background:#1f6feb; }

a {
  color:#2dd4bf;
  text-decoration:none;
}

.status-safe { color:#3fb950; font-weight:bold; }
.status-risk { color:#f85149; font-weight:bold; }
.status-queued { color:#d29922; }
.status-error { color:#f85149; }

.risk-bars span {
  display:inline-block;
  width:6px;
  height:14px;
  margin-right:2px;
  background:#30363d;
}

.risk-bars .on.red { background:#f85149; }
.risk-bars .on.orange { background:#f0883e; }
.risk-bars .on.yellow { background:#d29922; }
.risk-bars .on.green { background:#3fb950; }

footer {
  text-align:center;
  font-size:12px;
  color:#6e7681;
  margin-top:40px;
}
</style>
</head>

<body>

<h1>Polymarket GPT Bot Scanner</h1>
<p style="text-align:center;">Research-first scanner. AI must justify safety.</p>

<div style="text-align:center;">
<input id="apiKey" type="password" placeholder="Paste OpenAI API key" style="width:260px">
</div>

<div class="panel">
<strong>Market Filters</strong><br><br>
<label><input type="checkbox" data-cat="crypto" checked> Crypto</label>
<label><input type="checkbox" data-cat="politics"> Politics</label>
<label><input type="checkbox" data-cat="tech"> Tech / AI</label>
<label><input type="checkbox" data-cat="geo"> Geopolitics</label>
<label><input type="checkbox" data-cat="culture"> Culture</label>
<label><input type="checkbox" data-cat="sports"> Sports</label>
<label><input type="checkbox" data-cat="other"> Other</label>
</div>

<div style="text-align:center;">
<button id="toggleBtn" class="start">START SCANNER</button>
</div>

<div class="panel">
<div>Status: <span id="status">Stopped</span></div>
<div>AI Calls Used: <span id="aiCalls">0</span></div>
<div>AI Queue Length: <span id="queueLen">0</span></div>
</div>

<table>
<thead>
<tr>
<th>Market</th>
<th>Side</th>
<th>Prob</th>
<th>Risk</th>
<th>Status</th>
<th>Why (AI)</th>
<th>Profit (If Win)</th>
<th>Link</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<footer>gptbot.html v0007</footer>

<script>
/* ---------------- CONFIG ---------------- */
const API = "https://gamma-api.polymarket.com/markets?limit=500&active=true&closed=false";
const PROXY = "https://api.allorigins.win/raw?url=";
const AI_COOLDOWN = 5000;

/* ---------------- STATE ---------------- */
let running=false;
let aiCalls=0;
let lastAI=0;
let queue=[];
let markets=[];

/* ---------------- HELPERS ---------------- */
function riskBars(level){
  const colors=["red","orange","yellow","yellow","green","green"];
  let html='<div class="risk-bars">';
  for(let i=0;i<6;i++){
    html+=`<span class="${i<level?'on '+colors[level-1]:''}"></span>`;
  }
  return html+'</div>';
}

function profitTable(prob){
  const p=(1/prob)-1;
  return `$1→$${(1+p).toFixed(2)}<br>$10→$${(10+10*p).toFixed(2)}<br>$25→$${(25+25*p).toFixed(2)}`;
}

async function fetchJSON(url){
  try{
    const r=await fetch(PROXY+encodeURIComponent(url));
    return await r.json();
  }catch{return null;}
}

/* ---------------- AI QUEUE ---------------- */
async function processQueue(){
  if(!running || queue.length===0) return;
  const wait=Math.max(0,AI_COOLDOWN-(Date.now()-lastAI));
  if(wait>0){ setTimeout(processQueue,wait); return; }

  const job=queue.shift();
  document.getElementById("queueLen").textContent=queue.length;

  lastAI=Date.now();
  aiCalls++;
  document.getElementById("aiCalls").textContent=aiCalls;

  try{
    const res=await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${document.getElementById("apiKey").value}`
      },
      body:JSON.stringify({
        model:"gpt-4.1-mini",
        messages:[{
          role:"user",
          content:
`Market: "${job.m.question}"
End date applies strictly.
Assess risk of reversal before settlement.
Respond as:
SAFE | RISK
Then one <=250 char explanation grounded in THIS timeframe.`
        }]
      })
    });
    const j=await res.json();
    const text=j.choices?.[0]?.message?.content||"RISK";

    if(text.startsWith("SAFE")){
      job.row.querySelector(".status").innerHTML='<span class="status-safe">SAFE</span>';
      job.row.querySelector(".why").textContent=text.slice(4).trim();
    }else{
      job.row.querySelector(".status").innerHTML='<span class="status-risk">RISK</span>';
      job.row.querySelector(".why").textContent=text.slice(4).trim();
    }
  }catch{
    job.row.querySelector(".status").innerHTML='<span class="status-error">ERROR</span>';
    job.row.querySelector(".why").textContent="Rate limited or API error.";
  }

  processQueue();
}

/* ---------------- SCAN ---------------- */
async function scan(){
  const data=await fetchJSON(API)||[];
  const cats=[...document.querySelectorAll("input[data-cat]:checked")].map(x=>x.dataset.cat);
  const body=document.getElementById("rows");
  body.innerHTML="";
  markets=[];

  for(const m of data){
    if(markets.length>=20) break;
    let p=m.outcomePrices;
    if(typeof p==="string"){ try{p=JSON.parse(p);}catch{continue;} }
    if(!Array.isArray(p)) continue;

    const yes=p[0], no=p[1];
    let side,prob;
    if(yes>0.5){side="YES";prob=yes;}
    else{side="NO";prob=no;}

    markets.push({m,side,prob});
  }

  markets.forEach(obj=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${obj.m.question}</td>
      <td>${obj.side}</td>
      <td>${(obj.prob*100).toFixed(1)}%</td>
      <td>${riskBars(Math.min(6,Math.ceil(obj.prob*6)))}</td>
      <td class="status status-queued">QUEUED</td>
      <td class="why"></td>
      <td>${profitTable(obj.prob)}</td>
      <td><a href="https://polymarket.com/event/${obj.m.slug}" target="_blank">Open</a></td>
    `;
    body.appendChild(tr);
    queue.push({m:obj.m,row:tr});
  });

  document.getElementById("queueLen").textContent=queue.length;
  processQueue();
}

/* ---------------- TOGGLE ---------------- */
document.getElementById("toggleBtn").onclick=()=>{
  if(!running){
    running=true;
    document.getElementById("status").textContent="Running";
    document.getElementById("toggleBtn").textContent="STOP SCANNER";
    document.getElementById("toggleBtn").className="stop";
    scan();
  }else{
    running=false;
    queue=[];
    document.getElementById("status").textContent="Stopped";
    document.getElementById("toggleBtn").textContent="START SCANNER";
    document.getElementById("toggleBtn").className="start";
  }
};
</script>

</body>
</html>
